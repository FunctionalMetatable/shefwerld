<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf8">
        <title>Scratch Forum Post Statistics</title>
        <script src="Chart.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
        <style>
        *   {
            font-family: "Roboto";
            font-weight: 700;
        }
        body    {
            background-color: #333;
            margin: 0;
        }
        .userbox {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        #container, #heading, #top_text  {
            margin: auto;
            width: 90%;
        }
        .userposts, .totalposts, .postcountpercentage, .categorycount, .categoryrank   {
            text-align: right;
            color: #FFF;
        }
        .categoryranking, .category    {
            color: #FFF;
        }
        .category   {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        .userposts, .categorytext, .categorycount   {
            font-size: 20px;
        }
        .username, #top_text   {
            font-size: 20px;
            color: #f54260;
            text-decoration: none;
        }
        #titletext  {
            font-size: 52px;
            color: #fff;
            text-align: right;
            margin-bottom: 10px;
            margin-right: 20px;
        }
        form    {
            margin: auto;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        #footer    {
            width: 100%;
            margin: 0;
            display: flex;
            justify-content: space-around;
            color: #FFF;
            margin-top: 20px;
            background-color: #1C1C1C;
            padding: 25px 0 25px 0;
        }
        #footer a, #navigation a   {
            color: #f54260;
            text-decoration: none;
        }
        #navigation {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color: #1C1C1C;
            padding: 10px 0 10px 0;
            margin-bottom: 10px;
        }
        #overview   {
            display: flex;
            flex-direction: row;
            margin-bottom: 25px;
            background-color: #f54260;
            padding: 25px 0 25px 0;
        }
        #overview img   {
            width: 150px;
            height: 150px;
            margin: 0 0 5px 15px;
        }
        #overview-information   {
            order: 99;
            width: 100%;
            margin-left: 5%;
            display: flex;
            flex-direction: column-reverse;
        }
        #overview-postinformation   {
            text-align: right;
            font-size: 40px;
            color: #FFF;
            display: flex;
            justify-content: flex-end;
            margin-right: 20px;
        }
        #overview-postinformationdescription, #overview-accountstatus {
            text-align: right;
            font-size: 15px;
            color: #FFF;
            display: flex;
            justify-content: flex-end;
            margin-right: 20px; 
        }
        #overview-postinformation *, #overview-postinformationdescription *, #overview-accountstatus *   {
            margin: 0 15px 0 15px;
            width: 18%;
        }
        #overview-accountstatus {
            margin-bottom: 5px;
        }
        #piechart-container {
            width: 100%; 
            background-color: #000000;
        }
        #piechart-area  {
            width: 75%; 
            margin: auto;
        }
        </style>
    </head>
    <body>
        <div id="top_text" style="margin: auto; text-align: center; margin-bottom: 15px;">
            Scratch Forum Post Counts
        </div>
        <div id="container">
            <div id="navigation">
                <a href="index.html">Forum Categories</a>
                <a href="user.html">Users</a>
            </div>
        </div>
            <form action="" method="get">
                <input type="text" name="user" placeholder="Type username here"></input>
                <input type="submit" value="Go">
            </form>
            <div id="overview">
                <div id="overview-information">
                    <div id="overview-scratchinformation">

                    </div>
                    <div id="overview-postinformation">

                    </div>
                    <div id="overview-postinformationdescription">
                        <div id="overviewTotalPostsDescription">TOTAL POSTS</div>
                        <div id="overviewRankDescription">RANK</div>
                    </div>
                    <div id="overview-accountstatus">

                    </div>
                </div>
            </div>
            <div id="container">
            <div id="piechart-container">
            <div id="piechart-area">
                <canvas id="piechart"></canvas>
            </div>
            </div>
            <div id="content">
            </div>
        </div>
        <div id="footer">
            <div>Made by <a href="https://scratch.mit.edu/users/CatsUnited">CatsUnited</a></div>
            <div>Data from <a href="https://scratchdb.lefty.one/">ScratchDB</a> by <a href="https://scratch.mit.edu/users/DatOneLefty">DatOneLefty</a></div>
        </div>
        <div style="color: #FFF; text-align: center;">bottom text</div>
        <script>
            var chartCategories = [];
            var chartCounts = [];
            var chartColors = [];
            var urlparams = new URLSearchParams(window.location.search);
            var selectedUsername = urlparams.get("user");
            console.log(selectedUsername);
            var requestlist = [selectedUsername];
            var request = new XMLHttpRequest();
            (function loop(i, length){
                if (i >= length)    {
                    return;
                }
                var url = "https://scratchdb.lefty.one/v2/forum/user/info/" + requestlist[i];
                request.open("GET" ,url)
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var posters = JSON.parse(request.responseText);
                        function HSVtoRGB(h, s, v) {
                            var r, g, b, i, f, p, q, t;
                            if (arguments.length === 1) {
                                s = h.s, v = h.v, h = h.h;
                            }
                            i = Math.floor(h * 6);
                            f = h * 6 - i;
                            p = v * (1 - s);
                            q = v * (1 - f * s);
                            t = v * (1 - (1 - f) * s);
                            switch (i % 6) {
                                case 0: r = v, g = t, b = p; break;
                                case 1: r = q, g = v, b = p; break;
                                case 2: r = p, g = v, b = t; break;
                                case 3: r = p, g = q, b = v; break;
                                case 4: r = t, g = p, b = v; break;
                                case 5: r = v, g = p, b = q; break;
                            }
                            return {
                                r: Math.round(r * 255),
                                g: Math.round(g * 255),
                                b: Math.round(b * 255)
                            };
                        }
                        function componentToHex(c) {
                            var hex = c.toString(16);
                            return hex.length == 1 ? "0" + hex : hex;
                        }
                        function RGBtoHEX(r,g,b) {
                            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
                        }
                        function positionbruh(input)    {
                            switch (input)  {
                                case 1:
                                case 21:
                                case 31:
                                case 41:
                                case 51:
                                case 61:
                                case 71:
                                case 81:
                                case 91:
                                    return input + "st";
                                    break;
                                case 2:
                                case 22:
                                case 32:
                                case 42:
                                case 52:
                                case 62:
                                case 72:
                                case 82:
                                case 92:
                                    return input + "nd";
                                    break;
                                case 3:
                                case 23:
                                case 33:
                                case 43:
                                case 53:
                                case 63:
                                case 73:
                                case 83:
                                case 93:
                                    return input + "rd";
                                    break;
                                default:
                                    return input + "th";
                                }
                            }
                            /* title text */
                            titletext = document.createElement("div");
                            titletext.setAttribute("id", "titletext");
                            if (selectedUsername != null)   {titletext.appendChild(document.createTextNode(selectedUsername));}
                            document.getElementById("overview-information").appendChild(titletext);
                            /* overview total posts */
                            overviewTotalPosts = document.createElement("div");
                            overviewTotalPosts.setAttribute("id", "overviewTotalPosts");
                            console.log(posters.counts.total.count);
                            overviewTotalPosts.appendChild(document.createTextNode(posters.counts.total.count));
                            document.getElementById("overview-postinformation").appendChild(overviewTotalPosts);
                            /* overview rank */
                            overviewRank = document.createElement("div");
                            overviewRank.setAttribute("id", "overviewRank");
                            var ranking = positionbruh(posters.counts.total.rank);
                            overviewRank.appendChild(document.createTextNode(ranking));
                            document.getElementById("overview-postinformation").appendChild(overviewRank);
                            /* pie chart */
                            for (let i in posters.counts)    {
                                if (i == "total")   {
                                    break;
                                }
                                console.log(i);
                                /* box for particular category */
                                user = document.createElement("div");
                                user.setAttribute("id", i);
                                user.setAttribute("class", "category");
                                var randomColor = HSVtoRGB(Math.random(), 0.5, 0.35);
                                user.setAttribute("style", "background-color: rgb(" + randomColor.r + "," + randomColor.g + "," + randomColor.b + "); padding: 5px " + window.innerWidth/50 + "px 5px " + window.innerWidth/50 + "px;");
                                document.getElementById("content").appendChild(user);
                                /* category name */
                                categorytext = document.createElement("div");
                                categorytext.setAttribute("id", i);
                                categorytext.setAttribute("class", "categorytext");
                                if (i == "total")   {
                                    categorytext.appendChild(document.createTextNode("Total Posts"));
                                } else  {
                                    categorytext.appendChild(document.createTextNode(i));
                                }
                                document.getElementById(i).appendChild(categorytext);
                                /* right located content */
                                extrainfo = document.createElement("div");
                                extrainfo.setAttribute("id", "extrainfo" + i);
                                extrainfo.setAttribute("class", "extrainfo");
                                document.getElementById(i).appendChild(extrainfo);
                                /* category count */
                                categorycount = document.createElement("div");
                                categorycount.setAttribute("id", i + " Post Count");
                                categorycount.setAttribute("class", "categorycount");
                                categorycount.appendChild(document.createTextNode(posters.counts[i].count));
                                document.getElementById("extrainfo" + i).appendChild(categorycount);
                                /* category rank */
                                categoryrank = document.createElement("div");
                                categoryrank.setAttribute("id", i + " Ranking");
                                categoryrank.setAttribute("class", "categoryrank");
                                var ranking = positionbruh(posters.counts[i].rank);
                                categoryrank.appendChild(document.createTextNode(ranking));
                                document.getElementById("extrainfo" + i).appendChild(categoryrank);
                                /* category percentage */
                                fullpostcount = document.createElement("div");
                                fullpostcount.setAttribute("id", "totalposts" + i);
                                fullpostcount.setAttribute("class", "postcountpercentage");
                                var perecentageposts = Math.round(document.getElementById(i + " Post Count").innerHTML / posters.counts.total.count * 100 * 100)/100;
                                fullpostcount.appendChild(document.createTextNode(perecentageposts + "% of posts"));
                                document.getElementById("extrainfo" + i).appendChild(fullpostcount);

                                chartCounts.push(categorycount.innerHTML);
                                chartCategories.push(categorytext.innerHTML);
                                randomColor = RGBtoHEX(randomColor.r, randomColor.g, randomColor.b);
                                chartColors.push(randomColor);
                                }
                            }
                        loop(i+ 1, length);
                        /* pie graph */
                        var config = {
                            type: 'pie',
                            data: {
                                datasets: [{
                                    data: chartCounts,
                                    backgroundColor: chartColors,
                                    label: 'Scratcher Posts'
                                }],
                                labels: chartCategories,
                            },
                            options: {
                                responsive: true,
                            },
                        };
                            var ctx = document.getElementById('piechart').getContext('2d');
                            window.myPie = new Chart(ctx, config);
                    }
                request.send();
            })(0, requestlist.length);
        </script>
        <script>
        var cors_api_url = 'https://cors-anywhere.herokuapp.com/';
        function doCORSRequest(options, printResult) {
            var x = new XMLHttpRequest();
            x.open(options.method, cors_api_url + options.url);
            x.onload = x.onerror = function() {
            printResult(
                (x.responseText || '')
            );
            };
            if (/^POST/i.test(options.method)) {
                x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            }
            x.send(options.data);
        }
        var outputCORS = document.getElementById("overview");
        doCORSRequest({
            method: this.id === 'post' ? 'POST' : 'GET',
            url: "https://api.scratch.mit.edu/users/" + selectedUsername,
            data: outputCORS.value
        }, function printResult(result) {
            outputCORS.value = result;
            console.log(result);
            var ScratchAPIContents = JSON.parse(result);
            /* profile picture */
            var profilepicture = document.createElement("img");
            profilepicture.setAttribute("src", "https://cdn2.scratch.mit.edu/get_image/user/" + ScratchAPIContents.id + "_150x150.png?");
            document.getElementById("overview").appendChild(profilepicture);
            /* scratcher/scratch team */
            var scratcher = document.createElement("div");
            if (ScratchAPIContents.scratchteam === true)    {
                scratcher.appendChild(document.createTextNode("SCRATCH TEAM"));
            } else  {
                scratcher.appendChild(document.createTextNode("SCRATCHER"));
            }
            document.getElementById("overview-accountstatus").appendChild(scratcher);
        });
        </script>
    </body>
</html>